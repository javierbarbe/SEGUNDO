--procedimiento 1 vez
CREATE OR REPLACE PROCEDURE SUBE3
AS CURSOR CEMPLE
IS SELECT DEPT_NO, EMPLE.APELLIDO, SALARIO , ROWID
FROM EMPLE;
V_INCRE NUMBER;
V_JOB USER_JOBS.JOB%TYPE;

BEGIN 
SELECT JOB INTO V_JOB
FROM USER_JOBS
WHERE USER_JOBS.WHAT LIKE 'SUBE3;';

FOR REG_EMPLE IN CEMPLE
LOOP
IF REG_EMPLE.DEPT_NO = 10 THEN
V_INCRE:=10000;
ELSIF REG_EMPLE.DEPT_NO=20 THEN
V_INCRE:=2000;
ELSE 
V_INCRE:=4000;

END IF;


UPDATE EMPLE SET SALARIO = REG_EMPLE.SALARIO+V_INCRE WHERE
ROWID = REG_EMPLE.ROWID;
END LOOP;
DBMS_JOB.remove(V_JOB); -- LA CLAVE, ELIMINA DESPUES DE REALIZARSE
END SUBE3;


======================================0
CREATE OR REPLACE PROCEDURE LANZACOLA AS
NUMEROCOLA BINARY_INTEGER;
BEGIN
DBMS_JOB.SUBMIT(NUMEROCOLA,'SUBE3;', SYSDATE, 'SYSDATE + (10/(24*3600))');
dbms_output.put_line('trabajo enviado ocon el nmumero ' || numerocola);
  commit work;
  end lanzacola;
============================
CREATE OR REPLACE PROCEDURE ESTA1
AS
CURSOR C1 IS SELECT
        DEPT_NO, COUNT(*) TOTAL, ROUND(AVG(SALARIO),0) MEDIA
    FROM EMPLE
    GROUP BY DEPT_NO;
V_JOB USER_JOBS.JOB%TYPE;

BEGIN 
SELECT JOB INTO V_JOB
FROM USER_JOBS
WHERE USER_JOBS.WHAT LIKE 'ESTA%';
FOR REG1 IN C1 LOOP
UPDATE DATOSEMPLE
SET DEPARTAMENTO = REG1.DEPT_NO,
EMPLEADOS = REG1.TOTAL,
SALARIO = REG1.MEDIA
WHERE DEPARTAMENTO = REG1.DEPT_NO;
-- SI NO HAY COINCIDENCIA HAZ ESTO
IF SQL%NOTFOUND
THEN
INSERT INTO DATOSEMPLE
VALUES (REG1.DEPT_NO, REG1.TOTAL, REG1.MEDIA);
END IF;
END LOOP;

DBMS_JOB.WHAT(JOB=>V_JOB, WHAT=>'ESTA2;');
DBMS_OUTPUT.PUT_LINE('ESTADISTICA ACTUALIZADA');
COMMIT WORK;
EXCEPTION
WHEN OTHERS 
THEN
DBMS_OUTPUT.PUT_LINE('ERROR NUM ' || SQLCODE || ' TEXTO ' || SQLERRM);
END ESTA1;
=====================================0
CREATE OR REPLACE PROCEDURE ESTA2
AS
CURSOR C1 IS SELECT
        DEPT_NO, COUNT(*) TOTAL, SUM(SALARIO) SUMATORIO
    FROM EMPLE
    GROUP BY DEPT_NO;
V_JOB USER_JOBS.JOB%TYPE;

BEGIN 
SELECT JOB INTO V_JOB
FROM USER_JOBS
WHERE USER_JOBS.WHAT LIKE 'ESTA%';
FOR REG1 IN C1 LOOP
UPDATE DATOSEMPLE
SET DEPARTAMENTO = REG1.DEPT_NO,
EMPLEADOS = REG1.TOTAL,
SALARIO = REG1.SUMATORIO
WHERE DEPARTAMENTO = REG1.DEPT_NO;
-- SI NO HAY COINCIDENCIA HAZ ESTO
IF SQL%NOTFOUND
THEN
INSERT INTO DATOSEMPLE
VALUES (REG1.DEPT_NO, REG1.TOTAL, REG1.SUMATORIO);
END IF;
END LOOP;
DBMS_JOB.WHAT(JOB=>V_JOB, WHAT=>'ESTA1;');
DBMS_OUTPUT.PUT_LINE('ESTADISTICA ACTUALIZADA');
COMMIT WORK;
EXCEPTION
WHEN OTHERS 
THEN
DBMS_OUTPUT.PUT_LINE('ERROR NUM ' || SQLCODE || ' TEXTO ' || SQLERRM); -- ??? SQLTEXT
END ESTA2;
====================================0
CREATE OR REPLACE PROCEDURE LANZACOLA2 AS 
NUMEROCOLA BINARY_INTEGER;
BEGIN
DBMS_JOB.SUBMIT(NUMEROCOLA,'ESTA1;', SYSDATE, 'SYSDATE + (10/(24*3600))');
dbms_output.put_line('trabajo enviado ocon el nmumero ' || numerocola);
  commit work;
  end lanzacola2;
  
  SELECT JOB FROM USER_JOBS;
