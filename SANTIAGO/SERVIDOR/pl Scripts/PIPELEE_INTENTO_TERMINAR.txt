CREATE OR REPLACE TRIGGER P2PIPE
FOR UPDATE OF DIR OR INSERT
ON EMPLE
COMPOUND TRIGGER
-- DEFINO EL TIPO MIREGISTRO ... QUE ES LA DEFINICION DE LA TABLA
TYPE MIREGISTRO IS RECORD (
N_JEFE EMPLE.EMP_NO%TYPE,
CANTIDAD NUMBER);
-- CREO EL OBJETO TABLA QUE TIENE LOS CAMPOS N_JEFE Y CANTIDAD
TYPE MITABLA IS TABLE OF MIREGISTRO INDEX BY BINARY_INTEGER;
TABLON MITABLA;
BEFORE STATEMENT IS
  CURSOR C1 IS
  SELECT DIR, COUNT(*) CANTIDAD FROM EMPLE GROUP BY DIR;


V_APELLIDO EMPLE.APELLIDO%TYPE;
V_HANDLE UTL_FILE.file_type;
V_BUFFER VARCHAR2(100);
V_EMPNO  EMPLE.EMP_NO%TYPE;

--CURSOR C1 IS SELECT DIR, COUNT(*) TOTAL  FROM EMPLE GROUP BY DIR;
I BINARY_INTEGER DEFAULT 0;

CURSOR C2 IS SELECT 
EMP_NO, APELLIDO
FROM EMPLE;
-- FIN DECLARACION DE ELEMENTOS BEFORE STATEMENT

BEGIN
  V_HANDLE :=UTL_FILE.FOPEN('C:\TEMP\NOSE2', 'ACTUALIZACIONES.TXT', 'A') ;
  FOR REG1 IN C1 
    LOOP
      UPDATE TEMPO
      SET TEMPO.DIR= REG1.DIR
     -- TEMPO.TOTAL= REG1.TOTAL
      WHERE DIR =REG1.DIR;
      UTL_FILE.PUT_LINE('TOTALIDAD DE EMPLEADOS '  ||' DEL JEFE ' || REG1.DIR, 'ACTUALIZACIONES.TXT');
      
     
      IF SQL%NOTFOUND
        THEN 
          INSERT INTO TEMPO
          VALUES (REG1.DIR,REG1.TOTAL);
          END IF;
          
     END LOOP; 
    
     
     
     FOR REG2 IN C2
       LOOP
         UPDATE TEMPO2
         SET TEMPO2.NOMJEE = REG2.APELLIDO,
         TEMPO2.JEFE = REG2.EMP_NO
         where  JEFE = REG2.EMP_NO;
         
          IF SQL%NOTFOUND
              THEN 
              INSERT INTO TEMPO
              VALUES (REG2.NOMJEE  ,REG2.APELLIDO);
          END IF;
        END LOOP;
        END BEFORE STATEMENT; 
        END P2PIPE;