CREATE OR REPLACE TRIGGER P1
BEFORE UPDATE OF DIR OR INSERT ON EMPLE
-- PARTE UNO SOLUCIONA EL PROBLEMA DE LAS TABLAS MUTANTES
-- AL SER STATEMENT PODEMOS ACCEDEER A LA TABLA MUTANTE EMPLE

DECLARE 
CURSOR C2 
IS 
SELECT DIR , COUNT(*) TOTAL 
FROM EMPLE
GROUP BY DIR;

CURSOR C1 
IS
SELECT TEMPO.DIR, TEMPO..TOTAL 
FROM TEMPO;
I BINARY_INTEGERR DEFAULT 0;


MIA EXCEPTION;
V_HANDLE UTL_FILE.FILE_TYPE;

BEGIN 

FOR REG1 IN C1 
LOOP
UPDATE TEMPO
SET TEMPO.DIR = REG1.DIR,
TEMPO.TOTAL = REC1.TOTAL
WHERE DIR = REG1.DIR;

IF SQL%NOTFOUND
THEN 
INSERT INTO TEMPO
	VALUES (REG1.DIR, REG1.TOTAL)
====================================0
CREATE OR REPLACE TRIGGER P2 
FOR UPDATE OF DIR OR INSERT
ON EMPLE
COMPOUND TRIGGER
TYPE MIREGISTRO IS RECORD (
N_JEFE EMPLE.EMP_NO%TYPE,
CANTIDAD NUMBER);

TYPE MITABLA IS TABLE OF MIREGISTRO INDEX BY BINARY_INTEGER;
TABLON MITABLA;
BEFORE STATEMENT IS
	CURSOR C1 IS
	SELECT DIR, COUNT(*) CANTIDAD FROM EMPLE GROUP BY DIR;

AS
V_APELLIDO EMPLE.APELLIDO%TYPE;
V_HANDLE UTL_FILE.file_type;
V_BUFFER VARCHAR2(100);
V_EMPNO  EMPLE.EMP_NO%TYPE;

CURSOR C1 IS
SELECT DIR, COUNT(*) TOTAL 
FROM EMPLE
GROUP BY DIR;
I BINARY_INTEGER DEFAULT 0;

CURSOR C2 IS SELECT 
EMP_NO, APELLIDO
FROM EMPLE;


BEGIN
  V:HANDLE :=UTL.FILE.FOPEN('C:\TEMP\NOSE2', 'ACTUALIZACIONES.TXT', 'A') ;
  FOR REG1 IN C1 
    LOOP
      UPDATE TEMPO
      SET TEMPO.DIR= REG1.DIR,
      TEMPO.TOTAL= REG1.TOTAL
      WHERE DIR =REG1.DIR;
      
      IF SQL%NOTFOUND
        THEN 
          INSERT INTO TEMPO
          VALUES (REG1.DIR,REG1.TOTAL);
          END IF;
     END LOOP;
     
     FOR REG2 IN C2
       LOOP
         

------------------------------
CREATE OR REPLACE TRIGGER P2 
FOR UPDATE OF DIR OR INSERT
ON EMPLE
COMPOUND TRIGGER

-- aqui defino LAS VARIABLES 
V_APELLIDO		 EMPLE.APELLIDO%TYPE;
V_HANDLE 		 UTL_FILE.file_type;
V_BUFFER 		 VARCHAR2(100);
V_EMPNO  		 EMPLE.EMP_NO%TYPE;

-- DEFINO EL TIPO MIREGISTRO ... QUE ES LA DEFINICION DE LA TABLA
TYPE MIREGISTRO IS RECORD (
			N_JEFE EMPLE.EMP_NO%TYPE,
			CANTIDAD NUMBER);

-- CREO EL OBJETO TABLA QUE TIENE LOS CAMPOS N_JEFE Y CANTIDAD
TYPE MITABLA IS TABLE OF MIREGISTRO INDEX BY BINARY_INTEGER;
-- INSTANCIO UN OBJETO LLAMADO TABLON TIPO: MITABLA ( TENDRA LOS CAMPOS N_JEFE Y CANTIDAD)
TABLON MITABLA;

---------------------- FIN DE ZONA DE DECLARACIONES GLOBALES

BEFORE STATEMENT IS
  CURSOR C1 
	IS
  	SELECT DIR, COUNT(*) CANTIDAD FROM EMPLE GROUP BY DIR;
  I 	BINARY_INTEGER DEFAULT 0;

	BEGIN
	FOR REG1 IN C1 LOOP
		I:=I+1;
		TABLON(I).N_JEFE:= REG1.DIR;
		TABLON(I).CANTIDAD:=REG1.CANTIDAD;
		DBMS_OUTPUT.PUT_LINE('NJEFE '|| TABLON(I).N_JEFE ||' CANTIDAD ' 
					||TABLON(I).CANTIDAD);
	END LOOP;
	END BEFORE STATEMENT;
	
END P2;

CURSOR C1 IS
SELECT DIR, COUNT(*) TOTAL 
FROM EMPLE
GROUP BY DIR;
I BINARY_INTEGER DEFAULT 0;

CURSOR C2 IS SELECT 
EMP_NO, APELLIDO
FROM EMPLE;


BEGIN
  V:HANDLE :=UTL.FILE.FOPEN('C:\TEMP\NOSE2', 'ACTUALIZACIONES.TXT', 'A') ;
  FOR REG1 IN C1 
    LOOP
      UPDATE TEMPO
      SET TEMPO.DIR= REG1.DIR,
      TEMPO.TOTAL= REG1.TOTAL
      WHERE DIR =REG1.DIR;
      
      IF SQL%NOTFOUND
        THEN 
          INSERT INTO TEMPO
          VALUES (REG1.DIR,REG1.TOTAL);
          END IF;
     END LOOP;
     
     FOR REG2 IN C2
       LOOP
         