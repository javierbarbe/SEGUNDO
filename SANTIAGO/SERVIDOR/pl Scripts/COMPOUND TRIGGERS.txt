---COMPOUND TRIGGERS
CREATE OR REPLACE TRIGGER MUTANTE
FOR UPDATE OF SALARIO ON EMPLE
COMPOUND TRIGGER

-- DECLARACIONES GLOBALES
TYPE MIREGISTRO IS RECORD(
DEPARTAMENTO EMPLE.DEPT_NO%TYPE,
MEDIA        EMPLE.SALARIO%TYPE);

TYPE MITABLA IS TABLE OF MIREGISTRO INDEX BY BINARY_INTEGER;
TABLA MITABLA;
--------------------FIN DECLARACION GLOBAL (ANTES DEL PRIMER SUBEVENTO DEL DISPARADOR)
BEFORE STATEMENT IS -- EVITA LA TABLA MUTANTE Y NO PERMITE CARGAR LA TABLA EN MITALBA
  CURSOR C1 IS 
  SELECT DEPT_NO , AVG(SALARIO) MEDIA FROM EMPLE GROUP BY DEPT_NO;

  I BINARY_INTEGER DEFAULT 0;
    BEGIN
    FOR REG IN C1 LOOP 
      I:=I+1;
      TABLA(I).DEPARTAMENTO:= REG.DEPT_NO;
      TABLA(I).MEDIA:= REG.MEDIA;
    END LOOP;
END BEFORE STATEMENT;

AFTER EACH ROW IS
  BEGIN FOR I IN 1 .. TABLA.LAST LOOP
    IF :OLD.DEPT_NO = TABLA(I).DEPARTAMENTO THEN
      IF:NEW.SALARIO >2* TABLA(I).MEDIA THEN
        RAISE_APPLICATION_ERROR(-20000, 'NO SE PERMITE MAS DEL DOBLE');
      END IF;
    END IF;
  END LOOP;
DBMS_OUTPUT.PUT_LINE('ACTUALIZACION COMPLETA');

END AFTER EACH ROW;
END MUTANTE;

--------------------
--------------------
create or replace trigger CONTROLAGENTEDEP 
FOR UPDATE OF DEPT_NO ON EMPLE
  COMPOUND TRIGGER
  TYPE MIREG IS RECORD (
  CANTIDAD EMPLE.EMP_NO%TYPE ,
  DEPARTAMENTO EMPLE.DEPT_NO%TYPE);
  
  TYPE TIPOTABLA IS TABLE OF MIREG  INDEX BY BINARY_INTEGER;
  TABLITA TIPOTABLA;
  
  BEFORE STATEMENT IS 
  --  SELECT DEPT_NO , AVG(SALARIO) MEDIA FROM EMPLE GROUP BY DEPT_NO;
  CURSOR C1 IS SELECT DEPT_NO, COUNT(*) CANTIDAD FROM EMPLE GROUP BY DEPT_NO;
  I BINARY_INTEGER DEFAULT 0;
  BEGIN 
    FOR REG IN C1 LOOP
      I:=I+1;
      TABLITA(I).CANTIDAD := REG.CANTIDAD;
      TABLITA(I).DEPARTAMENTO:= REG.DEPT_NO;
      END LOOP;
      END BEFORE STATEMENT;
      
    AFTER EACH ROW IS
    BEGIN FOR I IN 1 .. TABLITA.LAST LOOP
  --  IF :OLD.DEPT_NO = TABLITA(I).DEPARTAMENTO THEN
      IF TABLITA(I).CANTIDAD >=4 THEN
        RAISE_APPLICATION_ERROR(-20000, 'NO SE PERMITE MAS DE 4 ');
      END IF;
   -- END IF;
  END LOOP;
DBMS_OUTPUT.PUT_LINE('ACTUALIZACION COMPLETA');

END AFTER EACH ROW;
      END CONTROLAGENTEDEP;